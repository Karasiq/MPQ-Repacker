<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc2">//---------------------------------------------------------------------------
</span><span class="sc9">#include &lt;windows.h&gt;
</span><span class="sc2">//---------------------------------------------------------------------------
</span><span class="sc9">#pragma argsused
#include "MPQRepackerAPI.h"
</span><span class="sc2">//---------------------------------------------------------------------------
</span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">HInstance</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc2">//---------------------------------------------------------------------------
</span><span class="sc9">#define DLLEXPORT extern "C" __declspec(dllexport)
</span><span class="sc2">//---------------------------------------------------------------------------
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">DummySearch</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">API_WriteLog</span><span class="sc10">(</span><span class="sc6">"[SamplePlugin override]: Плагин кагбе нашел файлы вместо проги"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Подсказка: После этой функции программа загрузит список файлов из
</span><span class="sc0">    </span><span class="sc2">// %APPDATA%\MPQ Repacker\FILELIST_CACHE.txt
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">DummyUnpack</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">API_WriteLog</span><span class="sc10">(</span><span class="sc6">"[SamplePlugin override]: А теперь распаковал"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Подсказка: распаковывать файлы надо во временную папку
</span><span class="sc0">    </span><span class="sc2">// путь к которой можно получить с помощью API-функции API_GetTempPath()
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">DummyPack</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">API_WriteLog</span><span class="sc10">(</span><span class="sc6">"[SamplePlugin override]: И даже упаковал"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Подсказка: паковать файлы надо из временной папки API_GetTempPath()
</span><span class="sc0">    </span><span class="sc2">// в файл карты, путь к которой возращает API_GetDestMap()
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">PluginLoad</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">API_WriteLog</span><span class="sc10">(</span><span class="sc6">"SamplePlugin 1.0 © ZxZ666"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">// Оверрайды - замены функций
</span><span class="sc0">    </span><span class="sc2">// Код обработки файлов в ReceiveCode помогает программе работать,
</span><span class="sc0">    </span><span class="sc2">// А в функциях-оверрайдах он заменяет соответствующие этапы работы программы
</span><span class="sc0">    </span><span class="sc2">// Т.е. поиск, распаковку, и упаковку
</span><span class="sc0">    </span><span class="sc11">TOverrideInfo</span><span class="sc0"> </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">OVERRIDE_SEARCH</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">Function</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">DummySearch</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">hPlugin</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HInstance</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">//////////////////////////////
</span><span class="sc0">    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">OVERRIDE_UNPACK</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">Function</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">DummyUnpack</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">].</span><span class="sc11">hPlugin</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HInstance</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">//////////////////////////////
</span><span class="sc0">    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">].</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">OVERRIDE_PACK</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">].</span><span class="sc11">Function</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">DummyPack</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">].</span><span class="sc11">hPlugin</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">HInstance</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">//////////////////////////////
</span><span class="sc0">    </span><span class="sc11">API_RegisterOverride</span><span class="sc10">(</span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">API_RegisterOverride</span><span class="sc10">(</span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc11">API_RegisterOverride</span><span class="sc10">(</span><span class="sc11">inf</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]);</span><span class="sc0">
    </span><span class="sc2">// Снимать оверрайды не надо, это сделает сама программа если вы
</span><span class="sc0">    </span><span class="sc2">// Правильно указали hPlugin, а если нет - то оверрайды просто
</span><span class="sc0">    </span><span class="sc2">// Не зарегистрируются - т.к. программа проверяет правильнось hPlugin
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">PluginUnload</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">API_WriteLog</span><span class="sc10">(</span><span class="sc6">"[ SamplePlugin unloaded ]"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc11">TPluginInfo</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">RegisterPlugin</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">TPluginInfo</span><span class="sc0"> </span><span class="sc11">Result</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Result</span><span class="sc10">.</span><span class="sc11">szName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"Sample plugin\0"</span><span class="sc10">;</span><span class="sc0">                                  </span><span class="sc2">// Название плагина
</span><span class="sc0">    </span><span class="sc11">Result</span><span class="sc10">.</span><span class="sc11">szAuthor</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"ZxZ666\0"</span><span class="sc10">;</span><span class="sc0">                                       </span><span class="sc2">// Автор
</span><span class="sc0">    </span><span class="sc11">Result</span><span class="sc10">.</span><span class="sc11">szDescription</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"Это ничего не делающий плагин-пример.\n(нажмите F1 чтобы открыть архив с исходниками)\0"</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// Описание
</span><span class="sc0">    </span><span class="sc2">// Настройки прерываний:
</span><span class="sc0">    </span><span class="sc11">Result</span><span class="sc10">.</span><span class="sc11">bHookFileFind</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// CODE_FILE_SEARCH_START и CODE_FILE_SEARCH_END
</span><span class="sc0">    </span><span class="sc11">Result</span><span class="sc10">.</span><span class="sc11">bHookFileUnpack</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc2">// CODE_FILES_UNPACKED
</span><span class="sc0">    </span><span class="sc11">Result</span><span class="sc10">.</span><span class="sc11">bHookFilePack</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">    </span><span class="sc2">// CODE_FILES_PACKED
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">Result</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">DLLEXPORT</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">CALLBACK</span><span class="sc0"> </span><span class="sc11">ReceiveCode</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">Code</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">szSourceMap</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">szDestMap</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">szTempDir</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">],</span><span class="sc0"> </span><span class="sc11">szAppDataDir</span><span class="sc10">[</span><span class="sc11">MAX_PATH</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">API_GetSourceMap</span><span class="sc10">(</span><span class="sc11">szSourceMap</span><span class="sc10">);</span><span class="sc0">      </span><span class="sc2">// Путь до исходной карты
</span><span class="sc0">    </span><span class="sc11">API_GetDestMap</span><span class="sc10">(</span><span class="sc11">szDestMap</span><span class="sc10">);</span><span class="sc0">          </span><span class="sc2">// Путь до результата (куда будет сохранена перепакованная карта)
</span><span class="sc0">    </span><span class="sc11">API_GetTempPath</span><span class="sc10">(</span><span class="sc11">szTempDir</span><span class="sc10">);</span><span class="sc0">         </span><span class="sc2">// Путь до указанной в настройках временной папки
</span><span class="sc0">    </span><span class="sc11">API_GetAppDataPath</span><span class="sc10">(</span><span class="sc11">szAppDataDir</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc2">// Путь до папки %APPDATA%\MPQ Repacker\ - там хранятся плагины, чит-паки, настройки и временный файл-лист FILELIST_CACHE.txt
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">CODE_FILE_SEARCH_START</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Начало поиска имен файлов"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SamplePlugin"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_ICONINFORMATION</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">CODE_FILE_SEARCH_END</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Конец поиска файлов\n(можно модифицировать %APPDATA%\\MPQ Repacker\\FILELIST_CACHE.txt - программа его перезагрузит)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SamplePlugin"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_ICONINFORMATION</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">CODE_FILES_UNPACKED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Файлы распакованы во временную папку\n(их можно модифицировать из плагина сейчас)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SamplePlugin"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_ICONINFORMATION</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">Code</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">CODE_FILES_PACKED</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">MessageBox</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"Файлы упакованы в MPQ архив\n(сейчас его можно оптимизировать)"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"SamplePlugin"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MB_ICONINFORMATION</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">MB_OK</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">GetLastError</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">WINAPI</span><span class="sc0"> </span><span class="sc11">DllMain</span><span class="sc10">(</span><span class="sc11">HINSTANCE</span><span class="sc0"> </span><span class="sc11">hinstDLL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">fwdreason</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LPVOID</span><span class="sc0"> </span><span class="sc11">lpvReserved</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">HInstance</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">hinstDLL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// Лучше не писать здесь ничего, для этого есть функции PluginLoad() и PluginUnload().
</span><span class="sc0">    </span><span class="sc2">// DllMain(DLL_PROCESS_ATTACH) вызывается не только при включении плагина,
</span><span class="sc0">    </span><span class="sc2">// но и при загрузке для получения информации о нём (RegisterPlugin),
</span><span class="sc0">    </span><span class="sc2">// а PluginLoad/PluginUnload вызываются соответственно только при включении/выключении
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span><span class="sc2">//---------------------------------------------------------------------------
</span></div></body>
</html>
